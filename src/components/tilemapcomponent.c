/* tilemapcomponent.c generated by valac 0.32.0, the Vala compiler
 * generated from tilemapcomponent.vala, do not modify */


#include <glib.h>
#include <glib-object.h>
#include <engine.h>
#include <tiled.h>
#include <SDL2/SDL_render.h>
#include <gxml/gxml.h>
#include <gee.h>
#include <stdlib.h>
#include <string.h>
#include <SDL2/SDL_rect.h>


#define TYPE_TILEMAP_COMPONENT (tilemap_component_get_type ())
#define TILEMAP_COMPONENT(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_TILEMAP_COMPONENT, TilemapComponent))
#define TILEMAP_COMPONENT_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_TILEMAP_COMPONENT, TilemapComponentClass))
#define IS_TILEMAP_COMPONENT(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_TILEMAP_COMPONENT))
#define IS_TILEMAP_COMPONENT_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_TILEMAP_COMPONENT))
#define TILEMAP_COMPONENT_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_TILEMAP_COMPONENT, TilemapComponentClass))

typedef struct _TilemapComponent TilemapComponent;
typedef struct _TilemapComponentClass TilemapComponentClass;
typedef struct _TilemapComponentPrivate TilemapComponentPrivate;

#define TYPE_TEXTURE_MANAGER (texture_manager_get_type ())
#define TEXTURE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_TEXTURE_MANAGER, TextureManager))
#define TEXTURE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_TEXTURE_MANAGER, TextureManagerClass))
#define IS_TEXTURE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_TEXTURE_MANAGER))
#define IS_TEXTURE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_TEXTURE_MANAGER))
#define TEXTURE_MANAGER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_TEXTURE_MANAGER, TextureManagerClass))

typedef struct _TextureManager TextureManager;
typedef struct _TextureManagerClass TextureManagerClass;
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))

#define TYPE_TEXTURE (texture_get_type ())
#define TEXTURE(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_TEXTURE, Texture))
#define TEXTURE_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_TEXTURE, TextureClass))
#define IS_TEXTURE(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_TEXTURE))
#define IS_TEXTURE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_TEXTURE))
#define TEXTURE_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_TEXTURE, TextureClass))

typedef struct _Texture Texture;
typedef struct _TextureClass TextureClass;
#define _g_free0(var) (var = (g_free (var), NULL))

#define TYPE_POSITION_COMPONENT (position_component_get_type ())
#define POSITION_COMPONENT(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), TYPE_POSITION_COMPONENT, PositionComponent))
#define POSITION_COMPONENT_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), TYPE_POSITION_COMPONENT, PositionComponentClass))
#define IS_POSITION_COMPONENT(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), TYPE_POSITION_COMPONENT))
#define IS_POSITION_COMPONENT_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), TYPE_POSITION_COMPONENT))
#define POSITION_COMPONENT_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), TYPE_POSITION_COMPONENT, PositionComponentClass))

typedef struct _PositionComponent PositionComponent;
typedef struct _PositionComponentClass PositionComponentClass;
typedef struct _PositionComponentPrivate PositionComponentPrivate;

#define POSITION_COMPONENT_TYPE_ENTITY_STATE (position_component_entity_state_get_type ())

struct _TilemapComponent {
	EngineComponent parent_instance;
	TilemapComponentPrivate * priv;
	TiledMap* map;
};

struct _TilemapComponentClass {
	EngineComponentClass parent_class;
};

struct _TilemapComponentPrivate {
	TextureManager* t;
	SDL_Renderer* r;
};

typedef enum  {
	POSITION_COMPONENT_ENTITY_STATE_GROUND,
	POSITION_COMPONENT_ENTITY_STATE_AIR
} PositionComponentEntityState;

struct _PositionComponent {
	EngineComponent parent_instance;
	PositionComponentPrivate * priv;
	gint x;
	gint y;
	gint velocity_x;
	gint velocity_y;
	PositionComponentEntityState state;
	SDL_RendererFlip flip;
};

struct _PositionComponentClass {
	EngineComponentClass parent_class;
};


static gpointer tilemap_component_parent_class = NULL;

GType tilemap_component_get_type (void) G_GNUC_CONST;
GType texture_manager_get_type (void) G_GNUC_CONST;
#define TILEMAP_COMPONENT_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), TYPE_TILEMAP_COMPONENT, TilemapComponentPrivate))
enum  {
	TILEMAP_COMPONENT_DUMMY_PROPERTY
};
TilemapComponent* tilemap_component_new (TiledMap* map, TextureManager* t, SDL_Renderer* r);
TilemapComponent* tilemap_component_construct (GType object_type, TiledMap* map, TextureManager* t, SDL_Renderer* r);
GType texture_get_type (void) G_GNUC_CONST;
Texture* texture_manager_load (TextureManager* self, const gchar* identifier, const gchar* filename, SDL_Renderer* renderer);
void tilemap_component_render (TilemapComponent* self, EngineEntity* camera);
GType position_component_get_type (void) G_GNUC_CONST;
GType position_component_entity_state_get_type (void) G_GNUC_CONST;
void texture_manager_draw_frame (TextureManager* self, const gchar* identifier, SDL_Rect* dst, gint row, gint column, SDL_RendererFlip flip, SDL_Renderer* renderer);
static void tilemap_component_finalize (GObject* obj);


static gpointer _g_object_ref0 (gpointer self) {
	return self ? g_object_ref (self) : NULL;
}


TilemapComponent* tilemap_component_construct (GType object_type, TiledMap* map, TextureManager* t, SDL_Renderer* r) {
	TilemapComponent * self = NULL;
	TiledMap* _tmp0_ = NULL;
	TiledMap* _tmp1_ = NULL;
	TextureManager* _tmp29_ = NULL;
	SDL_Renderer* _tmp30_ = NULL;
	g_return_val_if_fail (map != NULL, NULL);
	g_return_val_if_fail (t != NULL, NULL);
	g_return_val_if_fail (r != NULL, NULL);
	self = (TilemapComponent*) engine_component_construct (object_type);
	_tmp0_ = map;
	_tmp1_ = _g_object_ref0 (_tmp0_);
	_g_object_unref0 (self->map);
	self->map = _tmp1_;
	{
		GXmlSerializableArrayList* _ts_list = NULL;
		TiledMap* _tmp2_ = NULL;
		GXmlSerializableArrayList* _tmp3_ = NULL;
		GXmlSerializableArrayList* _tmp4_ = NULL;
		GXmlSerializableArrayList* _tmp5_ = NULL;
		gint _ts_size = 0;
		GXmlSerializableArrayList* _tmp6_ = NULL;
		gint _tmp7_ = 0;
		gint _tmp8_ = 0;
		gint _ts_index = 0;
		_tmp2_ = self->map;
		_tmp3_ = tiled_map_get_tileset (_tmp2_);
		_tmp4_ = _tmp3_;
		_tmp5_ = _g_object_ref0 (_tmp4_);
		_ts_list = _tmp5_;
		_tmp6_ = _ts_list;
		_tmp7_ = gee_abstract_collection_get_size ((GeeCollection*) _tmp6_);
		_tmp8_ = _tmp7_;
		_ts_size = _tmp8_;
		_ts_index = -1;
		while (TRUE) {
			gint _tmp9_ = 0;
			gint _tmp10_ = 0;
			gint _tmp11_ = 0;
			TiledTileset* ts = NULL;
			GXmlSerializableArrayList* _tmp12_ = NULL;
			gint _tmp13_ = 0;
			gpointer _tmp14_ = NULL;
			TextureManager* _tmp15_ = NULL;
			TiledTileset* _tmp16_ = NULL;
			const gchar* _tmp17_ = NULL;
			const gchar* _tmp18_ = NULL;
			TiledTileset* _tmp19_ = NULL;
			TiledImage* _tmp20_ = NULL;
			TiledImage* _tmp21_ = NULL;
			const gchar* _tmp22_ = NULL;
			const gchar* _tmp23_ = NULL;
			gchar* _tmp24_ = NULL;
			gchar* _tmp25_ = NULL;
			SDL_Renderer* _tmp26_ = NULL;
			Texture* _tmp27_ = NULL;
			Texture* _tmp28_ = NULL;
			_tmp9_ = _ts_index;
			_ts_index = _tmp9_ + 1;
			_tmp10_ = _ts_index;
			_tmp11_ = _ts_size;
			if (!(_tmp10_ < _tmp11_)) {
				break;
			}
			_tmp12_ = _ts_list;
			_tmp13_ = _ts_index;
			_tmp14_ = gee_abstract_list_get ((GeeAbstractList*) _tmp12_, _tmp13_);
			ts = (TiledTileset*) _tmp14_;
			_tmp15_ = t;
			_tmp16_ = ts;
			_tmp17_ = tiled_tileset_get_name (_tmp16_);
			_tmp18_ = _tmp17_;
			_tmp19_ = ts;
			_tmp20_ = tiled_tileset_get_image (_tmp19_);
			_tmp21_ = _tmp20_;
			_tmp22_ = tiled_image_get_source (_tmp21_);
			_tmp23_ = _tmp22_;
			_tmp24_ = g_strconcat ("data/", _tmp23_, NULL);
			_tmp25_ = _tmp24_;
			_tmp26_ = r;
			_tmp27_ = texture_manager_load (_tmp15_, _tmp18_, _tmp25_, _tmp26_);
			_tmp28_ = _tmp27_;
			_g_object_unref0 (_tmp28_);
			_g_free0 (_tmp25_);
			_g_object_unref0 (ts);
		}
		_g_object_unref0 (_ts_list);
	}
	_tmp29_ = t;
	self->priv->t = _tmp29_;
	_tmp30_ = r;
	self->priv->r = _tmp30_;
	return self;
}


TilemapComponent* tilemap_component_new (TiledMap* map, TextureManager* t, SDL_Renderer* r) {
	return tilemap_component_construct (TYPE_TILEMAP_COMPONENT, map, t, r);
}


void tilemap_component_render (TilemapComponent* self, EngineEntity* camera) {
	PositionComponent* camerapos = NULL;
	EngineEntity* _tmp0_ = NULL;
	gpointer _tmp1_ = NULL;
	g_return_if_fail (self != NULL);
	g_return_if_fail (camera != NULL);
	_tmp0_ = camera;
	_tmp1_ = engine_entity_get_component (_tmp0_, TYPE_POSITION_COMPONENT, (GBoxedCopyFunc) g_object_ref, g_object_unref);
	camerapos = (PositionComponent*) _tmp1_;
	{
		gint i = 0;
		i = 0;
		{
			gboolean _tmp2_ = FALSE;
			_tmp2_ = TRUE;
			while (TRUE) {
				gint _tmp4_ = 0;
				TiledMap* _tmp5_ = NULL;
				gint _tmp6_ = 0;
				gint _tmp7_ = 0;
				if (!_tmp2_) {
					gint _tmp3_ = 0;
					_tmp3_ = i;
					i = _tmp3_ + 1;
				}
				_tmp2_ = FALSE;
				_tmp4_ = i;
				_tmp5_ = self->map;
				_tmp6_ = tiled_map_get_height (_tmp5_);
				_tmp7_ = _tmp6_;
				if (!(_tmp4_ < _tmp7_)) {
					break;
				}
				{
					gint j = 0;
					j = 0;
					{
						gboolean _tmp8_ = FALSE;
						_tmp8_ = TRUE;
						while (TRUE) {
							gint _tmp10_ = 0;
							TiledMap* _tmp11_ = NULL;
							gint _tmp12_ = 0;
							gint _tmp13_ = 0;
							gint tilenumber = 0;
							gint _tmp14_ = 0;
							gint _tmp15_ = 0;
							TiledMap* _tmp16_ = NULL;
							gint _tmp17_ = 0;
							gint _tmp18_ = 0;
							SDL_Rect dst = {0};
							gint _tmp19_ = 0;
							TiledMap* _tmp20_ = NULL;
							gint _tmp21_ = 0;
							gint _tmp22_ = 0;
							PositionComponent* _tmp23_ = NULL;
							gint _tmp24_ = 0;
							gint _tmp25_ = 0;
							TiledMap* _tmp26_ = NULL;
							gint _tmp27_ = 0;
							gint _tmp28_ = 0;
							TiledMap* _tmp29_ = NULL;
							gint _tmp30_ = 0;
							gint _tmp31_ = 0;
							TiledMap* _tmp32_ = NULL;
							gint _tmp33_ = 0;
							gint _tmp34_ = 0;
							SDL_Rect _tmp35_ = {0};
							gint row = 0;
							TiledMap* _tmp36_ = NULL;
							GXmlSerializableArrayList* _tmp37_ = NULL;
							GXmlSerializableArrayList* _tmp38_ = NULL;
							gpointer _tmp39_ = NULL;
							TiledLayer* _tmp40_ = NULL;
							TiledData* _tmp41_ = NULL;
							TiledData* _tmp42_ = NULL;
							GXmlSerializableArrayList* _tmp43_ = NULL;
							GXmlSerializableArrayList* _tmp44_ = NULL;
							gint _tmp45_ = 0;
							gpointer _tmp46_ = NULL;
							TiledTile* _tmp47_ = NULL;
							gint _tmp48_ = 0;
							gint _tmp49_ = 0;
							TiledMap* _tmp50_ = NULL;
							GXmlSerializableArrayList* _tmp51_ = NULL;
							GXmlSerializableArrayList* _tmp52_ = NULL;
							gpointer _tmp53_ = NULL;
							TiledTileset* _tmp54_ = NULL;
							gint _tmp55_ = 0;
							gint _tmp56_ = 0;
							gint _tmp57_ = 0;
							gint column = 0;
							TiledMap* _tmp58_ = NULL;
							GXmlSerializableArrayList* _tmp59_ = NULL;
							GXmlSerializableArrayList* _tmp60_ = NULL;
							gpointer _tmp61_ = NULL;
							TiledLayer* _tmp62_ = NULL;
							TiledData* _tmp63_ = NULL;
							TiledData* _tmp64_ = NULL;
							GXmlSerializableArrayList* _tmp65_ = NULL;
							GXmlSerializableArrayList* _tmp66_ = NULL;
							gint _tmp67_ = 0;
							gpointer _tmp68_ = NULL;
							TiledTile* _tmp69_ = NULL;
							gint _tmp70_ = 0;
							gint _tmp71_ = 0;
							TiledMap* _tmp72_ = NULL;
							GXmlSerializableArrayList* _tmp73_ = NULL;
							GXmlSerializableArrayList* _tmp74_ = NULL;
							gpointer _tmp75_ = NULL;
							TiledTileset* _tmp76_ = NULL;
							gint _tmp77_ = 0;
							gint _tmp78_ = 0;
							gint _tmp79_ = 0;
							TextureManager* _tmp80_ = NULL;
							TiledMap* _tmp81_ = NULL;
							GXmlSerializableArrayList* _tmp82_ = NULL;
							GXmlSerializableArrayList* _tmp83_ = NULL;
							gpointer _tmp84_ = NULL;
							TiledTileset* _tmp85_ = NULL;
							const gchar* _tmp86_ = NULL;
							const gchar* _tmp87_ = NULL;
							SDL_Rect _tmp88_ = {0};
							gint _tmp89_ = 0;
							gint _tmp90_ = 0;
							SDL_Renderer* _tmp91_ = NULL;
							if (!_tmp8_) {
								gint _tmp9_ = 0;
								_tmp9_ = j;
								j = _tmp9_ + 1;
							}
							_tmp8_ = FALSE;
							_tmp10_ = j;
							_tmp11_ = self->map;
							_tmp12_ = tiled_map_get_width (_tmp11_);
							_tmp13_ = _tmp12_;
							if (!(_tmp10_ < _tmp13_)) {
								break;
							}
							_tmp14_ = j;
							_tmp15_ = i;
							_tmp16_ = self->map;
							_tmp17_ = tiled_map_get_width (_tmp16_);
							_tmp18_ = _tmp17_;
							tilenumber = _tmp14_ + (_tmp15_ * _tmp18_);
							_tmp19_ = j;
							_tmp20_ = self->map;
							_tmp21_ = tiled_map_get_tilewidth (_tmp20_);
							_tmp22_ = _tmp21_;
							_tmp23_ = camerapos;
							_tmp24_ = _tmp23_->x;
							_tmp25_ = i;
							_tmp26_ = self->map;
							_tmp27_ = tiled_map_get_tileheight (_tmp26_);
							_tmp28_ = _tmp27_;
							_tmp29_ = self->map;
							_tmp30_ = tiled_map_get_tilewidth (_tmp29_);
							_tmp31_ = _tmp30_;
							_tmp32_ = self->map;
							_tmp33_ = tiled_map_get_tileheight (_tmp32_);
							_tmp34_ = _tmp33_;
							memset (&_tmp35_, 0, sizeof (SDL_Rect));
							_tmp35_.x = (_tmp19_ * _tmp22_) - _tmp24_;
							_tmp35_.y = _tmp25_ * _tmp28_;
							_tmp35_.w = (guint) _tmp31_;
							_tmp35_.h = (guint) _tmp34_;
							dst = _tmp35_;
							_tmp36_ = self->map;
							_tmp37_ = tiled_map_get_layer (_tmp36_);
							_tmp38_ = _tmp37_;
							_tmp39_ = gee_abstract_list_get ((GeeAbstractList*) _tmp38_, 0);
							_tmp40_ = (TiledLayer*) _tmp39_;
							_tmp41_ = tiled_layer_get_data (_tmp40_);
							_tmp42_ = _tmp41_;
							_tmp43_ = tiled_data_get_tiles (_tmp42_);
							_tmp44_ = _tmp43_;
							_tmp45_ = tilenumber;
							_tmp46_ = gee_abstract_list_get ((GeeAbstractList*) _tmp44_, _tmp45_);
							_tmp47_ = (TiledTile*) _tmp46_;
							_tmp48_ = tiled_tile_get_gid (_tmp47_);
							_tmp49_ = _tmp48_;
							_tmp50_ = self->map;
							_tmp51_ = tiled_map_get_tileset (_tmp50_);
							_tmp52_ = _tmp51_;
							_tmp53_ = gee_abstract_list_get ((GeeAbstractList*) _tmp52_, 0);
							_tmp54_ = (TiledTileset*) _tmp53_;
							_tmp55_ = tiled_tileset_get_columns (_tmp54_);
							_tmp56_ = _tmp55_;
							_tmp57_ = _tmp49_ / _tmp56_;
							_g_object_unref0 (_tmp54_);
							_g_object_unref0 (_tmp47_);
							_g_object_unref0 (_tmp40_);
							row = _tmp57_;
							_tmp58_ = self->map;
							_tmp59_ = tiled_map_get_layer (_tmp58_);
							_tmp60_ = _tmp59_;
							_tmp61_ = gee_abstract_list_get ((GeeAbstractList*) _tmp60_, 0);
							_tmp62_ = (TiledLayer*) _tmp61_;
							_tmp63_ = tiled_layer_get_data (_tmp62_);
							_tmp64_ = _tmp63_;
							_tmp65_ = tiled_data_get_tiles (_tmp64_);
							_tmp66_ = _tmp65_;
							_tmp67_ = tilenumber;
							_tmp68_ = gee_abstract_list_get ((GeeAbstractList*) _tmp66_, _tmp67_);
							_tmp69_ = (TiledTile*) _tmp68_;
							_tmp70_ = tiled_tile_get_gid (_tmp69_);
							_tmp71_ = _tmp70_;
							_tmp72_ = self->map;
							_tmp73_ = tiled_map_get_tileset (_tmp72_);
							_tmp74_ = _tmp73_;
							_tmp75_ = gee_abstract_list_get ((GeeAbstractList*) _tmp74_, 0);
							_tmp76_ = (TiledTileset*) _tmp75_;
							_tmp77_ = tiled_tileset_get_columns (_tmp76_);
							_tmp78_ = _tmp77_;
							_tmp79_ = (_tmp71_ % _tmp78_) - 1;
							_g_object_unref0 (_tmp76_);
							_g_object_unref0 (_tmp69_);
							_g_object_unref0 (_tmp62_);
							column = _tmp79_;
							_tmp80_ = self->priv->t;
							_tmp81_ = self->map;
							_tmp82_ = tiled_map_get_tileset (_tmp81_);
							_tmp83_ = _tmp82_;
							_tmp84_ = gee_abstract_list_get ((GeeAbstractList*) _tmp83_, 0);
							_tmp85_ = (TiledTileset*) _tmp84_;
							_tmp86_ = tiled_tileset_get_name (_tmp85_);
							_tmp87_ = _tmp86_;
							_tmp88_ = dst;
							_tmp89_ = row;
							_tmp90_ = column;
							_tmp91_ = self->priv->r;
							texture_manager_draw_frame (_tmp80_, _tmp87_, &_tmp88_, _tmp89_, _tmp90_, SDL_FLIP_NONE, _tmp91_);
							_g_object_unref0 (_tmp85_);
						}
					}
				}
			}
		}
	}
	_g_object_unref0 (camerapos);
}


static void tilemap_component_class_init (TilemapComponentClass * klass) {
	tilemap_component_parent_class = g_type_class_peek_parent (klass);
	g_type_class_add_private (klass, sizeof (TilemapComponentPrivate));
	G_OBJECT_CLASS (klass)->finalize = tilemap_component_finalize;
}


static void tilemap_component_instance_init (TilemapComponent * self) {
	self->priv = TILEMAP_COMPONENT_GET_PRIVATE (self);
}


static void tilemap_component_finalize (GObject* obj) {
	TilemapComponent * self;
	self = G_TYPE_CHECK_INSTANCE_CAST (obj, TYPE_TILEMAP_COMPONENT, TilemapComponent);
	_g_object_unref0 (self->map);
	G_OBJECT_CLASS (tilemap_component_parent_class)->finalize (obj);
}


GType tilemap_component_get_type (void) {
	static volatile gsize tilemap_component_type_id__volatile = 0;
	if (g_once_init_enter (&tilemap_component_type_id__volatile)) {
		static const GTypeInfo g_define_type_info = { sizeof (TilemapComponentClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) tilemap_component_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (TilemapComponent), 0, (GInstanceInitFunc) tilemap_component_instance_init, NULL };
		GType tilemap_component_type_id;
		tilemap_component_type_id = g_type_register_static (ENGINE_TYPE_COMPONENT, "TilemapComponent", &g_define_type_info, 0);
		g_once_init_leave (&tilemap_component_type_id__volatile, tilemap_component_type_id);
	}
	return tilemap_component_type_id__volatile;
}



